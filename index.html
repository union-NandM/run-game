<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUN</title>
    <style>
        * {
            margin: 0;
        }
        #canvas-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            width: min(100vh, 100vw);
            height: min(100vh, 100vw);
            background-color: lavenderblush;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>
    <script>
        (() => {
            
            const colors = {
                black: "#000000",
                white: "#ffffff",
                lightskyblue: "#87CEFA",
                whitesmoke: "#F5F5F5",
                lightgray: "#D3D3D3",
                darkgray: "#A9A9A9",
                silver: "#C0C0C0",
                slategray: "#708090",
                lightslategray: "#778899",
                gray: "#808080",
                treegreen1: "#CCCC99",
                treegreen2: "#669966",
            }
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const container = document.getElementById("canvas-container");
            const resize = () => {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
            resize();
            let isGaming = true;
            const reset = () => {
                ctx.fillStyle = colors.whitesmoke;
                ctx.fillRect(0,0,canvas.width,canvas.height);
            }
            const ground = {
                left: 0,
                top: canvas.height*2/3,
                width: canvas.width,
                height: canvas.height/3,
                color: colors.lightslategray,
                
                draw(ctx) {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.left,this.top,this.width,this.height);
                }
            }
            const judgeHit = (p,r) => {
                return [
                    ((p.right > r.left && p.left < r.left) || (r.right > p.left && r.left < p.left)),
                    ((p.bottom > r.top && p.top < r.top) || (r.bottom > p.top && r.top < p.top))
                ];
            }
            const drawScore = (ctx,t) => {
                ctx.fillStyle = colors.silver;
                ctx.font = "20px sanserif";
                ctx.textBaseline = "top";
                ctx.textAlign = "right";

                ctx.fillText(t, canvas.width -10, 10);
            }
            class Tree {
                constructor(t, c) {
                    this.color = c;
                    this.height = 40 + Math.random() * 40;
                    this.width = this.height * 2 / Math.tan(Math.PI * 4 / 10);
                    this.top = ground.top - this.height;
                    this.bottom = ground.top;
                    this.left = canvas.width;
                    this.right = this.left + this.width;
                    this.speed = 5 + Math.floor(t/500);
                }
                update = (t) => {
                    this.speed = 5 + Math.floor(t/500);
                    this.left -= this.speed;
                    this.right -= this.speed;
                }
                draw = (ctx) => {
                    ctx.globalAlpha = 0.5;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.moveTo(this.left, this.bottom);
                    ctx.lineTo(this.left + this.width/2, this.top);
                    ctx.lineTo(this.right, this.bottom);
                    ctx.closePath();
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
                
            }
            class Rock {
                constructor(t) {
                    this.width = 40;
                    this.height = 20;
                    this.left = canvas.width;
                    this.top = ground.top - this.height;
                    this.right = this.left + this.width;
                    this.bottom = ground.top;
                    this.color = colors.gray;
                    this.speed = 5 + Math.floor(t/500);
                }
                update = (t) => {
                    this.speed = 5 + (Math.floor(t/500));
                    this.left -= this.speed;
                    this.right -= this.speed;
                }
                draw = (ctx) => {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(
                        this.left,
                        this.top,
                        this.width,
                        this.height
                        );
                }
            }
            class Player {
                constructor() {
                    this.width = 30;
                    this.height = 30;
                    this.left = canvas.width/5;
                    this.top = ground.top - this.height;
                    this.right = this.left + this.width;
                    this.bottom = ground.top;
                    this.color = colors.darkgray;
                    this.vy = 0;
                    this.isGrounded  = true;
                }

                setY = (y) => {
                    this.top = y;
                    this.bottom = this.top + this.height;
                }
                
                setX = (x) => {
                    this.left = x;
                    this.right = this.left + this.width;
                }
                
                moveX = (x) => {
                    this.left += x;
                    this.right += x;
                }

                moveY = (y) => {
                    this.top += y;
                    this.bottom += y;
                }

                update = () => {
                    if (!this.isGrounded) {
                        this.moveY(-this.vy);
                        this.vy -= 1;
                        if (this.bottom > ground.top) {
                            this.setY(ground.top - this.height);
                            this.isGrounded = true;
                            this.vy = 0;
                        }
                    }
                }

                checkHit = (obj) => {
                    if (this.left < obj.left && this.right > obj.left) {
                        if (this.bottom > obj.top) {
                            console.log("end!");
                            isGaming = false;
                        }
                    }
                    if (this.right > obj.left && this.right < obj.right) {
                        if (this.bottom >= obj.top) {
                            console.log("end!");
                            isGaming = false;
                        }
                    }
                }
                
                draw = (ctx) => {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(
                        this.left,
                        this.top,
                        this.width,
                        this.height
                        );
                }

                
            }
            const player = new Player();
            let rocks = [];
            let trees = [];
            let time = 0;
            let rockInterval = 0;
            let treeInterval = 0;
            let preJudgement = [false,false];
            const intervalid = setInterval(() => {
                if (isGaming) {
                    trees = trees.filter(tree => tree.right > 0);
                    for (tree of trees) {
                        tree.update(time);
                    }
                    rocks = rocks.filter(rock => rock.right > 0);
                    const prePlayer = {
                        ...player
                    }
                    player.update();
                    for (rock of rocks) {
                        preJudgement = judgeHit(prePlayer, rock);
                        rock.update(time);
                        const nowJudgement = judgeHit(player, rock);
                        if (nowJudgement[0] && nowJudgement[1]) {
                            isGaming = false;
                            if (!preJudgement[0]) {
                                player.setX(rock.left - player.width);
                            }
                            if (!preJudgement[1]) {
                                player.setY(rock.top - player.height);
                            }
                        }
                    }
                    reset();
                    ground.draw(ctx);
                    for (tree of trees) {
                        tree.draw(ctx);
                    }
                    player.draw(ctx);
                    for (rock of rocks) {
                        rock.draw(ctx);
                    }
                    drawScore(ctx,time);
                    time++;
                    
                    if (treeInterval === 0) {
                        const rand = Math.random() * 100;
                        if (rand < 5) {
                            treeInterval = 30;
                            if (rand < 3) {
                                trees.push(new Tree(time, colors.treegreen1));
                            } else {
                                trees.push(new Tree(time, colors.treegreen2))
                            }
                            console.log(trees);
                        }
                    } else {
                        treeInterval--;
                    }
                    if (rockInterval === 0) {
                        const rand = Math.random() * 100;
                        if (rand < 3) {
                            rocks.push(new Rock(time));
                            rockInterval = 50;
                        }
                    } else {
                        rockInterval--;
                    }
                }
            }, 20);
            addEventListener("click", () => {
                if (player.isGrounded) {
                    player.vy += 11;
                    player.isGrounded = false;
                }
            });
        })();

    </script>
</body>
</html>
